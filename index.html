<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GÃ¶rsel &amp; Ä°Ã§erik Excel DÃ¶nÃ¼ÅŸtÃ¼rÃ¼cÃ¼</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --green:       #217346;
      --green-dark:  #185c37;
      --green-light: #e7f3ec;
      --border:      #d1d5db;
      --bg:          #f3f4f6;
      --card:        #ffffff;
      --text:        #111827;
      --muted:       #6b7280;
      --row-even:    #f0f7ee;
      --shadow:      0 1px 3px rgba(0,0,0,.12);
      --shadow-lg:   0 8px 24px rgba(0,0,0,.12);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg); color: var(--text); min-height: 100vh;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: linear-gradient(135deg, var(--green-dark), var(--green));
      color: #fff; padding: 1.4rem 2rem;
      box-shadow: var(--shadow-lg);
      display: flex; align-items: center; gap: 1rem;
    }
    header .logo { font-size: 2rem; }
    header h1 { font-size: 1.35rem; font-weight: 700; letter-spacing: -.02em; }
    header p  { font-size: .82rem; opacity: .8; margin-top: .15rem; }

    .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }

    /* â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .upload-area {
      background: var(--card); border: 2.5px dashed var(--border);
      border-radius: 14px; padding: 3rem 2rem; text-align: center;
      transition: border-color .2s, background .2s; box-shadow: var(--shadow);
    }
    .upload-area.drag-over { border-color: var(--green); background: var(--green-light); }
    .upload-icon { font-size: 3rem; margin-bottom: .75rem; }
    .upload-area h2 { font-size: 1.15rem; font-weight: 600; margin-bottom: .35rem; }
    .upload-area > p { color: var(--muted); font-size: .875rem; margin-bottom: 1.25rem; }

    .formats { display: flex; flex-wrap: wrap; justify-content: center; gap: .4rem; margin-bottom: 1.5rem; }
    .badge { border-radius: 100px; padding: .18rem .65rem; font-size: .75rem; font-weight: 700; }
    .badge-green  { background: var(--green-light); color: var(--green-dark); border: 1px solid #b7dfca; }
    .badge-blue   { background: #dbeafe; color: #1e40af;  border: 1px solid #bfdbfe; }
    .badge-orange { background: #fff7ed; color: #9a3412;  border: 1px solid #fed7aa; }

    .upload-btns { display: flex; gap: .75rem; justify-content: center; flex-wrap: wrap; }

    /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn {
      display: inline-flex; align-items: center; gap: .45rem;
      padding: .6rem 1.2rem; border: none; border-radius: 8px;
      font-size: .875rem; font-weight: 600; cursor: pointer; transition: all .15s ease;
    }
    .btn-green  { background: var(--green); color: #fff; }
    .btn-green:hover  { background: var(--green-dark); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(33,115,70,.35); }
    .btn-blue   { background: #2563eb; color: #fff; }
    .btn-blue:hover   { background: #1d4ed8; transform: translateY(-1px); }
    .btn-export { background: #1d6f42; color: #fff; }
    .btn-export:hover { background: #155433; transform: translateY(-1px); }
    .btn-ghost  { background: #fff; color: var(--text); border: 1px solid var(--border); }
    .btn-ghost:hover  { background: var(--bg); }

    /* â”€â”€ OCR notice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ocr-notice {
      background: #fefce8; border: 1px solid #fde68a;
      border-radius: 8px; padding: .6rem 1rem;
      font-size: .82rem; color: #92400e; margin-top: .75rem;
      display: flex; align-items: center; gap: .5rem;
    }

    /* â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .progress-card {
      background: var(--card); border-radius: 14px;
      padding: 2.5rem 2rem; text-align: center; box-shadow: var(--shadow);
    }
    .progress-card h2 { font-size: 1.05rem; font-weight: 600; margin: .75rem 0 .5rem; }
    .progress-track { background: #e5e7eb; border-radius: 100px; height: 9px; overflow: hidden; margin: .75rem 0; }
    .progress-fill  { height: 100%; background: linear-gradient(90deg, var(--green), #4ade80); border-radius: 100px; width: 0%; transition: width .3s ease; }
    .progress-msg   { font-size: .82rem; color: var(--muted); }
    .progress-sub   { font-size: .78rem; color: #9ca3af; margin-top: .3rem; }

    /* â”€â”€ Result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .result-card { background: var(--card); border-radius: 14px; box-shadow: var(--shadow); overflow: hidden; }
    .result-topbar {
      display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;
      padding: 1rem 1.5rem; background: var(--bg); border-bottom: 1px solid var(--border);
    }
    .result-topbar h2 { font-size: .95rem; font-weight: 600; max-width: 420px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .stat-badge { background: var(--green-light); color: var(--green-dark); border-radius: 100px; padding: .18rem .6rem; font-size: .78rem; font-weight: 700; margin-right: .4rem; }
    .actions { display: flex; gap: .6rem; flex-wrap: wrap; }

    /* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-scroll { overflow: auto; max-height: 72vh; }

    table.xl { width: 100%; border-collapse: collapse; font-size: .875rem; }
    table.xl thead { position: sticky; top: 0; z-index: 10; }

    table.xl th.rn, table.xl td.rn {
      width: 42px; min-width: 42px; background: #e9ecef; color: var(--muted);
      text-align: center; font-size: .78rem; border: 1px solid var(--border); padding: .5rem .25rem;
    }
    table.xl thead th {
      background: var(--green); color: #fff; text-align: center;
      padding: .75rem 1rem; font-size: .85rem; font-weight: 700;
      letter-spacing: .05em; text-transform: uppercase; border: 1px solid rgba(255,255,255,.2);
      white-space: nowrap;
    }
    table.xl thead th.col-img { width: 280px; min-width: 240px; }
    table.xl thead th.col-txt { min-width: 180px; }

    table.xl tbody tr:nth-child(even) { background: var(--row-even); }
    table.xl tbody tr:hover { background: #dbeafe; }
    table.xl td { vertical-align: top; border: 1px solid var(--border); padding: .7rem .9rem; }
    table.xl td.col-img { text-align: center; }

    .thumb { max-width: 240px; max-height: 180px; object-fit: contain; border-radius: 4px; cursor: zoom-in; transition: transform .2s; }
    .thumb:hover { transform: scale(1.04); }
    .img-label  { font-size: .7rem; color: var(--muted); margin-top: .35rem; word-break: break-all; }
    .no-img     { color: #9ca3af; font-style: italic; font-size: .82rem; padding: 1rem 0; }

    .cell-text {
      white-space: pre-wrap; line-height: 1.7; outline: none;
      min-height: 2.5rem; padding: 2px; width: 100%;
    }
    .cell-text:focus { background: #fefce8; border-radius: 4px; }

    /* â”€â”€ Lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .lb-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.88); z-index: 9999; align-items: center; justify-content: center; }
    .lb-overlay.open { display: flex; }
    .lb-overlay img { max-width: 92vw; max-height: 92vh; object-fit: contain; border-radius: 6px; }
    .lb-close { position: absolute; top: 1rem; right: 1.2rem; background: #fff; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }

    .hidden { display: none !important; }
    .mt     { margin-top: 1.25rem; }

    @media (max-width: 640px) {
      .container { padding: 1rem; }
      table.xl thead th.col-img { width: 150px; min-width: 130px; }
      .thumb { max-width: 130px; max-height: 110px; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">ğŸ“Š</div>
  <div>
    <h1>GÃ¶rsel &amp; Ä°Ã§erik Excel DÃ¶nÃ¼ÅŸtÃ¼rÃ¼cÃ¼</h1>
    <p>GÃ¶rseli Excel'e gÃ¶m Â· OCR ile yazÄ±larÄ± ayrÄ± sÃ¼tunlara aktar</p>
  </div>
</header>

<div class="container">

  <!-- Upload -->
  <div id="uploadSection" class="upload-area"
       ondragover="onDragOver(event)" ondrop="onDrop(event)" ondragleave="onDragLeave(event)">
    <div class="upload-icon">ğŸ“‚</div>
    <h2>Dosya, klasÃ¶r veya ZIP'i buraya sÃ¼rÃ¼kleyin</h2>
    <p>GÃ¶rsellerdeki yazÄ±lar OCR ile okunur ve her biri ayrÄ± sÃ¼tuna yerleÅŸtirilir</p>
    <div class="formats">
      <span class="badge badge-blue">PNG</span>
      <span class="badge badge-blue">JPG</span>
      <span class="badge badge-blue">WEBP</span>
      <span class="badge badge-green">PDF</span>
      <span class="badge badge-green">DOCX</span>
      <span class="badge badge-orange">ZIP</span>
      <span class="badge badge-orange">KlasÃ¶r</span>
    </div>
    <div class="upload-btns">
      <button class="btn btn-green" onclick="fileInput.click()">ğŸ“„ Dosya / GÃ¶rsel SeÃ§</button>
      <button class="btn btn-blue"  onclick="folderInput.click()">ğŸ“ KlasÃ¶r SeÃ§</button>
    </div>
    <div class="ocr-notice">
      âš¡ Ä°lk OCR iÅŸleminde dil paketi (~4 MB) indirilir â€” internet baÄŸlantÄ±sÄ± gerekir. Sonraki kullanÄ±mlarda anlÄ±k Ã§alÄ±ÅŸÄ±r.
    </div>
    <input type="file" id="fileInput" multiple accept=".pdf,.docx,.doc,.png,.jpg,.jpeg,.webp,.gif,.bmp,.zip" style="display:none" onchange="handleFiles(this.files)" />
    <input type="file" id="folderInput" multiple webkitdirectory style="display:none" onchange="handleFiles(this.files)" />
  </div>

  <!-- Progress -->
  <div id="progressSection" class="progress-card mt hidden">
    <div style="font-size:2.2rem">âš™ï¸</div>
    <h2>Ä°ÅŸleniyorâ€¦</h2>
    <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
    <p class="progress-msg" id="progressMsg">LÃ¼tfen bekleyinâ€¦</p>
    <p class="progress-sub" id="progressSub"></p>
  </div>

  <!-- Result -->
  <div id="resultSection" class="result-card mt hidden">
    <div class="result-topbar">
      <div>
        <h2 id="resultFilename">â€”</h2>
        <div style="display:flex;align-items:center;gap:.4rem;margin-top:.25rem;font-size:.8rem;color:var(--muted)">
          <span class="stat-badge" id="statCount">0</span> kayÄ±t &nbsp;Â·&nbsp;
          HÃ¼crelere tÄ±klayarak dÃ¼zenleme yapabilirsiniz
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-export" onclick="exportExcel()">ğŸ“¥ Excel'e Aktar (GÃ¶rselli)</button>
        <button class="btn btn-ghost"  onclick="resetApp()">ğŸ”„ Yeni Dosya</button>
      </div>
    </div>
    <div class="table-scroll">
      <table class="xl" id="xlTable">
        <thead id="xlHead">
          <tr>
            <th class="rn">#</th>
            <th class="col-img">GÃ¶rseller</th>
          </tr>
        </thead>
        <tbody id="xlBody"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- Lightbox -->
<div class="lb-overlay" id="lbOverlay" onclick="closeLb()">
  <button class="lb-close" onclick="closeLb()">âœ•</button>
  <img id="lbImg" src="" alt="" onclick="event.stopPropagation()" />
</div>

<script>
// â”€â”€ Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const IMAGE_EXTS = ['jpg','jpeg','png','webp','gif','bmp','tiff','avif'];
const TEXT_EXTS  = ['txt'];

let tableData   = [];   // [{index, label, imgSrc, textLines:[]}]
let currentName = 'tablo';
let tessWorker  = null;

// â”€â”€ Tesseract worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getTess() {
  if (tessWorker) return tessWorker;
  setProgress(3, 'OCR motoru yÃ¼kleniyorâ€¦', 'Ä°lk seferde dil paketi indiriliyor (~4 MB)');
  tessWorker = await Tesseract.createWorker('tur+eng', 1, { logger: () => {} });
  return tessWorker;
}

async function ocrImg(imgSrc) {
  const w = await getTess();
  const { data } = await w.recognize(imgSrc);
  return (data.lines || [])
    .map(l => l.text.replace(/\r?\n/g, ' ').trim())
    .filter(l => l.length > 1);
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const getExt   = name => name.split('.').pop().toLowerCase();
const MIME_MAP = { jpg:'image/jpeg', jpeg:'image/jpeg', png:'image/png',
                   webp:'image/webp', gif:'image/gif', bmp:'image/bmp' };
const getMime  = ext => MIME_MAP[ext] || 'image/jpeg';

function fileToDataURL(file) {
  return new Promise(res => { const r = new FileReader(); r.onload = e => res(e.target.result); r.readAsDataURL(file); });
}

function splitText(text) {
  return text.split(/\n+/).map(l => l.trim()).filter(l => l.length > 1);
}

// â”€â”€ Drag & Drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onDragOver(e)  { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function onDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }

async function onDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const items = Array.from(e.dataTransfer.items || []);
  const files = Array.from(e.dataTransfer.files || []);
  if (items.length && items[0].webkitGetAsEntry) {
    const entries = items.map(i => i.webkitGetAsEntry()).filter(Boolean);
    if (entries.some(en => en && en.isDirectory)) {
      const all = [];
      for (const en of entries) await readEntry(en, all);
      return route(all, 'KlasÃ¶r', 'images');
    }
  }
  if (files.length) handleFiles(files);
}

async function readEntry(entry, out) {
  if (!entry) return;
  if (entry.isFile) {
    const f = await new Promise(res => entry.file(res));
    out.push(f);
  } else if (entry.isDirectory) {
    const reader = entry.createReader();
    let batch;
    do {
      batch = await new Promise(res => reader.readEntries(res));
      for (const ch of batch) await readEntry(ch, out);
    } while (batch.length);
  }
}

// â”€â”€ Routing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleFiles(fileList) {
  const files = Array.from(fileList);
  if (!files.length) return;
  if (files.length === 1) {
    const ext = getExt(files[0].name);
    if (ext === 'pdf')                    return route(files, files[0].name, 'pdf');
    if (ext === 'docx' || ext === 'doc') return route(files, files[0].name, 'docx');
    if (ext === 'zip')                   return route(files, files[0].name, 'zip');
    if (IMAGE_EXTS.includes(ext))        return route(files, files[0].name, 'images');
  }
  route(files, `${files.length} dosya`, 'images');
}

async function route(files, label, type) {
  currentName = (typeof label === 'string' ? label : 'tablo').replace(/\.[^.]+$/, '');
  showProgress();
  setProgress(0, 'BaÅŸlatÄ±lÄ±yorâ€¦', '');
  try {
    let rows = [];
    if      (type === 'pdf')  rows = await processPDF(files[0]);
    else if (type === 'docx') rows = await processDOCX(files[0]);
    else if (type === 'zip')  rows = await processZIP(files[0]);
    else                      rows = await processImages(files);

    if (!rows.length) {
      alert('GÃ¶rsel veya iÃ§erik bulunamadÄ±. DosyalarÄ± kontrol edin.');
      resetProgress(); return;
    }
    tableData = rows;
    renderTable(rows);
    showResult(label, rows.length);
  } catch (err) {
    console.error(err);
    alert('Hata:\n' + err.message);
    resetProgress();
  }
}

// â”€â”€ PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function processPDF(file) {
  const buf = await file.arrayBuffer();
  setProgress(5, 'PDF yÃ¼kleniyorâ€¦', '');
  const pdf  = await pdfjsLib.getDocument({ data: buf }).promise;
  const rows = [];
  for (let i = 1; i <= pdf.numPages; i++) {
    setProgress(5 + Math.round(i / pdf.numPages * 88), `Sayfa ${i}/${pdf.numPages} iÅŸleniyorâ€¦`, '');
    const page     = await pdf.getPage(i);
    const viewport = page.getViewport({ scale: 1.6 });
    const canvas   = document.createElement('canvas');
    canvas.width   = viewport.width; canvas.height = viewport.height;
    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
    const tc       = await page.getTextContent();
    const text     = tc.items.map(t => t.str).join('\n').trim();
    rows.push({ index: i, label: `Sayfa ${i}`, imgSrc: canvas.toDataURL('image/jpeg', .88), textLines: splitText(text) });
  }
  setProgress(100, 'TamamlandÄ±!', '');
  return rows;
}

// â”€â”€ DOCX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function processDOCX(file) {
  const buf = await file.arrayBuffer();
  setProgress(10, 'Word dosyasÄ± okunuyorâ€¦', '');
  const result = await mammoth.convertToHtml({ arrayBuffer: buf }, {
    convertImage: mammoth.images.imgElement(img =>
      img.read('base64').then(b64 => ({ src: 'data:' + img.contentType + ';base64,' + b64 })))
  });
  setProgress(60, 'EÅŸleÅŸtiriliyorâ€¦', '');
  const parser = new DOMParser();
  const doc    = parser.parseFromString(result.value, 'text/html');
  const rows   = [];
  let curImg = null, curTexts = [], idx = 0;

  function flush() {
    if (curImg !== null) {
      rows.push({ index: ++idx, label: `GÃ¶rsel ${idx}`, imgSrc: curImg,
                  textLines: curTexts.filter(t => t.length > 1) });
      curImg = null; curTexts = [];
    }
  }
  for (const el of Array.from(doc.body.children)) {
    const img = el.querySelector('img');
    if (img) { flush(); curImg = img.src; }
    else { const t = el.textContent.trim(); if (t) curTexts.push(t); }
  }
  flush();

  if (!rows.length) {
    const imgs  = Array.from(doc.querySelectorAll('img'));
    const texts = Array.from(doc.querySelectorAll('p,h1,h2,h3,h4,li')).map(e => e.textContent.trim()).filter(Boolean);
    imgs.forEach((img, i) => rows.push({ index: i+1, label: `GÃ¶rsel ${i+1}`, imgSrc: img.src, textLines: texts[i] ? [texts[i]] : [] }));
  }
  setProgress(100, 'TamamlandÄ±!', '');
  return rows;
}

// â”€â”€ Image files â†’ OCR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function processImages(files) {
  const imgFiles = files.filter(f => IMAGE_EXTS.includes(getExt(f.name)));
  const txtFiles = files.filter(f => TEXT_EXTS.includes(getExt(f.name)));

  imgFiles.sort((a, b) => (a.webkitRelativePath || a.name).localeCompare(b.webkitRelativePath || b.name));

  // Build sidecar .txt lookup
  const textMap = {};
  for (const tf of txtFiles) {
    const key = tf.name.replace(/\.[^.]+$/, '').toLowerCase();
    textMap[key] = await tf.text();
  }

  const rows = [];
  for (let i = 0; i < imgFiles.length; i++) {
    const f    = imgFiles[i];
    const lbl  = f.webkitRelativePath || f.name;
    const key  = f.name.replace(/\.[^.]+$/, '').toLowerCase();
    const pct  = Math.round(((i) / imgFiles.length) * 90);
    setProgress(pct, `GÃ¶rsel ${i+1}/${imgFiles.length} OCR iÅŸleniyorâ€¦`, lbl);

    const imgSrc   = await fileToDataURL(f);
    let textLines;

    if (textMap[key]) {
      // Sidecar .txt dosyasÄ± varsa OCR'a gerek yok
      textLines = splitText(textMap[key]);
    } else {
      // OCR
      try { textLines = await ocrImg(imgSrc); }
      catch(e) { console.warn('OCR failed:', e); textLines = []; }
    }

    rows.push({ index: i+1, label: lbl, imgSrc, textLines });
  }
  setProgress(100, 'TamamlandÄ±!', '');
  return rows;
}

// â”€â”€ ZIP â†’ OCR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function processZIP(file) {
  const buf = await file.arrayBuffer();
  setProgress(5, 'ZIP aÃ§Ä±lÄ±yorâ€¦', '');
  const zip = await JSZip.loadAsync(buf);

  const imgEntries = [], txtEntries = [];
  zip.forEach((path, entry) => {
    if (entry.dir || path.startsWith('__MACOSX')) return;
    const ext = getExt(path);
    if (IMAGE_EXTS.includes(ext)) imgEntries.push({ path, entry, ext });
    if (TEXT_EXTS.includes(ext))  txtEntries.push({ path, entry });
  });
  imgEntries.sort((a, b) => a.path.localeCompare(b.path));

  const textMap = {};
  for (const { path, entry } of txtEntries) {
    const fname = path.split('/').pop();
    textMap[fname.replace(/\.[^.]+$/, '').toLowerCase()] = await entry.async('string');
  }

  const rows = [];
  for (let i = 0; i < imgEntries.length; i++) {
    const { path, entry, ext } = imgEntries[i];
    const fname = path.split('/').pop();
    const key   = fname.replace(/\.[^.]+$/, '').toLowerCase();
    const pct   = 8 + Math.round((i / imgEntries.length) * 82);
    setProgress(pct, `GÃ¶rsel ${i+1}/${imgEntries.length} OCR iÅŸleniyorâ€¦`, path);

    const b64    = await entry.async('base64');
    const imgSrc = `data:${getMime(ext)};base64,${b64}`;
    let textLines;

    if (textMap[key]) {
      textLines = splitText(textMap[key]);
    } else {
      try { textLines = await ocrImg(imgSrc); }
      catch(e) { console.warn('OCR failed:', e); textLines = []; }
    }

    rows.push({ index: i+1, label: path, imgSrc, textLines });
  }
  setProgress(100, 'TamamlandÄ±!', '');
  return rows;
}

// â”€â”€ Render table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable(rows) {
  const maxCols = Math.max(0, ...rows.map(r => r.textLines.length));

  // Build header
  const thead = document.getElementById('xlHead');
  const headerRow = thead.querySelector('tr');
  // Clear existing text-col headers
  while (headerRow.children.length > 2) headerRow.removeChild(headerRow.lastChild);
  for (let c = 0; c < maxCols; c++) {
    const th = document.createElement('th');
    th.className   = 'col-txt';
    th.textContent = `Ä°Ã§erik ${c + 1}`;
    headerRow.appendChild(th);
  }

  const tbody = document.getElementById('xlBody');
  tbody.innerHTML = '';

  rows.forEach((row, ri) => {
    const tr = document.createElement('tr');

    // # cell
    const tdRn = document.createElement('td');
    tdRn.className = 'rn'; tdRn.textContent = row.index;
    tr.appendChild(tdRn);

    // Image cell
    const tdImg = document.createElement('td');
    tdImg.className = 'col-img';
    if (row.imgSrc) {
      const img = document.createElement('img');
      img.className = 'thumb'; img.src = row.imgSrc; img.alt = row.label; img.title = 'BÃ¼yÃ¼tmek iÃ§in tÄ±klayÄ±n';
      img.addEventListener('click', () => openLb(row.imgSrc));
      tdImg.appendChild(img);
      const lbl = document.createElement('div');
      lbl.className = 'img-label'; lbl.textContent = row.label;
      tdImg.appendChild(lbl);
    } else {
      const nv = document.createElement('div');
      nv.className = 'no-img'; nv.textContent = 'GÃ¶rsel yok';
      tdImg.appendChild(nv);
    }
    tr.appendChild(tdImg);

    // Text columns
    for (let c = 0; c < maxCols; c++) {
      const td  = document.createElement('td');
      td.className = 'col-txt';
      const div = document.createElement('div');
      div.className = 'cell-text';
      div.contentEditable = 'true';
      div.textContent = row.textLines[c] || '';
      div.addEventListener('blur', () => {
        if (!tableData[ri].textLines) tableData[ri].textLines = [];
        tableData[ri].textLines[c] = div.textContent.trim();
      });
      td.appendChild(div);
      tr.appendChild(td);
    }

    tbody.appendChild(tr);
  });
}

// â”€â”€ Excel export (ExcelJS â€” gerÃ§ek gÃ¶rsel gÃ¶mme) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function exportExcel() {
  const btn = document.querySelector('.btn-export');
  btn.disabled = true; btn.textContent = 'â³ HazÄ±rlanÄ±yorâ€¦';

  try {
    const maxCols = Math.max(0, ...tableData.map(r => r.textLines.length));

    const wb = new ExcelJS.Workbook();
    wb.creator  = 'GÃ¶rsel Excel DÃ¶nÃ¼ÅŸtÃ¼rÃ¼cÃ¼';
    wb.created  = new Date();

    const ws = wb.addWorksheet('ÃœrÃ¼n Tablosu');

    // Column widths (ExcelJS char units â‰ˆ 7px)
    ws.getColumn(1).width = 32;  // GÃ¶rsel ~225px
    for (let c = 1; c <= maxCols; c++) ws.getColumn(c + 1).width = 28;

    // Header row
    const hdr = ws.getRow(1);
    hdr.height = 26;
    hdr.getCell(1).value = 'GÃ¶rsel';
    for (let c = 1; c <= maxCols; c++) hdr.getCell(c + 1).value = `Ä°Ã§erik ${c}`;
    hdr.eachCell(cell => {
      cell.fill      = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF217346' } };
      cell.font      = { bold: true, color: { argb: 'FFFFFFFF' }, size: 11 };
      cell.alignment = { horizontal: 'center', vertical: 'middle' };
      cell.border    = { bottom: { style: 'medium', color: { argb: 'FF185C37' } } };
    });

    const ROW_H_PT   = 100; // ~133px
    const IMG_W_PX   = 210;
    const IMG_H_PX   = 125;

    for (let ri = 0; ri < tableData.length; ri++) {
      const row   = tableData[ri];
      const wsRow = ws.getRow(ri + 2);
      wsRow.height = ROW_H_PT;

      // Text cells
      for (let c = 0; c < maxCols; c++) {
        const cell  = wsRow.getCell(c + 2);
        cell.value  = row.textLines[c] || '';
        cell.alignment = { wrapText: true, vertical: 'middle' };
        cell.font      = { size: 10 };
        cell.border    = {
          top:    { style: 'thin', color: { argb: 'FFD1D5DB' } },
          bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
          left:   { style: 'thin', color: { argb: 'FFD1D5DB' } },
          right:  { style: 'thin', color: { argb: 'FFD1D5DB' } }
        };
      }

      // Embed image
      if (row.imgSrc) {
        try {
          const parts  = row.imgSrc.split(';base64,');
          const mime   = parts[0].replace('data:', '');
          const base64 = parts[1];
          const extMap = { 'image/jpeg':'jpeg','image/png':'png','image/gif':'gif','image/webp':'jpeg','image/bmp':'jpeg' };
          const ext    = extMap[mime] || 'jpeg';

          const imgId = wb.addImage({ base64, extension: ext });
          ws.addImage(imgId, {
            tl:     { col: 0, row: ri + 1 },
            ext:    { width: IMG_W_PX, height: IMG_H_PX },
            editAs: 'oneCell'
          });

          // Style the gÃ¶rsel cell border
          const imgCell = wsRow.getCell(1);
          imgCell.border = {
            top:    { style: 'thin', color: { argb: 'FFD1D5DB' } },
            bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
            left:   { style: 'thin', color: { argb: 'FFD1D5DB' } },
            right:  { style: 'thin', color: { argb: 'FFD1D5DB' } }
          };
        } catch (imgErr) {
          console.warn('GÃ¶rsel eklenemedi:', imgErr);
          wsRow.getCell(1).value = row.label;
        }
      }
    }

    const buffer = await wb.xlsx.writeBuffer();
    const blob   = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url    = URL.createObjectURL(blob);
    const a      = document.createElement('a');
    a.href       = url;
    a.download   = (currentName || 'tablo') + '_tablo.xlsx';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);

  } catch (err) {
    console.error(err);
    alert('Excel dÄ±ÅŸa aktarma hatasÄ±:\n' + err.message);
  } finally {
    btn.disabled    = false;
    btn.textContent = 'ğŸ“¥ Excel\'e Aktar (GÃ¶rselli)';
  }
}

// â”€â”€ Lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openLb(src) { document.getElementById('lbImg').src = src; document.getElementById('lbOverlay').classList.add('open'); }
function closeLb()   { document.getElementById('lbOverlay').classList.remove('open'); document.getElementById('lbImg').src = ''; }
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeLb(); });

// â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showProgress() {
  document.getElementById('uploadSection').classList.add('hidden');
  document.getElementById('progressSection').classList.remove('hidden');
  document.getElementById('resultSection').classList.add('hidden');
}
function resetProgress() {
  document.getElementById('uploadSection').classList.remove('hidden');
  document.getElementById('progressSection').classList.add('hidden');
}
function showResult(label, count) {
  document.getElementById('progressSection').classList.add('hidden');
  document.getElementById('resultSection').classList.remove('hidden');
  document.getElementById('resultFilename').textContent = label;
  document.getElementById('statCount').textContent = count;
}
function setProgress(pct, msg, sub) {
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressMsg').textContent  = msg;
  document.getElementById('progressSub').textContent  = sub || '';
}
function resetApp() {
  tableData = [];
  // Clear extra header columns
  const hr = document.querySelector('#xlHead tr');
  while (hr.children.length > 2) hr.removeChild(hr.lastChild);
  document.getElementById('xlBody').innerHTML  = '';
  document.getElementById('fileInput').value   = '';
  document.getElementById('folderInput').value = '';
  document.getElementById('uploadSection').classList.remove('hidden');
  document.getElementById('resultSection').classList.add('hidden');
  document.getElementById('progressSection').classList.add('hidden');
}
</script>
</body>
</html>
